name: DevSecOps Pipeline

on: [push, pull_request]

jobs:
  # ═══════════════════════════════════════
  # 1. BUILD
  # Construit l'image Docker de l'application
  # Permet de valider que le code compile et de préparer l'image pour le scan de vulnérabilités
  # ═══════════════════════════════════════
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t vuln-app:${{ github.sha }} .

      - name: Save image
        run: docker save vuln-app:${{ github.sha }} > image.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar

  # ═══════════════════════════════════════
  # 2. SAST - Analyse statique du code (Static Application Security Testing)
  # Détecte les vulnérabilités dans le CODE SOURCE : injection SQL, XSS, failles de sécurité
  # Outil : Semgrep avec règles OWASP Top 10, security-audit, et détection de secrets
  # ═══════════════════════════════════════
  sast:
    name: SAST
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten

   # ═══════════════════════════════════════
   # 3. SCA - Analyse des dépendances (Software Composition Analysis)
   # Détecte les vulnérabilités dans les BIBLIOTHÈQUES et packages tiers (npm, etc.)
   # Outil : npm audit pour vérifier les CVE connues dans les dépendances Node.js
   # ═══════════════════════════════════════
   sca:
     name: SCA
     runs-on: ubuntu-latest
     steps:
       - uses: actions/checkout@v4

       - name: Setup Node.js
         uses: actions/setup-node@v4
         with:
           node-version: '18'

       - name: Install dependencies
         working-directory: ./src
         run: npm install

       - name: npm audit
         working-directory: ./src
         run: |
           npm audit --json > audit.json
           npm audit

      - uses: actions/upload-artifact@v4
       with:
         name: npm-audit
         path: src/audit.json

# ═══════════════════════════════════════
# 4. SECRET DETECTION
# Détecte les SECRETS accidentellement committés : clés API, mots de passe, tokens
# Outil : Gitleaks qui scanne tout l'historique Git (fetch-depth: 0)
# Critique : évite les fuites de credentials et violations de sécurité
# ═══════════════════════════════════════
secrets:
  name: Secrets
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ═══════════════════════════════════════
# 5. CONTAINER SCAN
# Scanne l'IMAGE DOCKER pour détecter les vulnérabilités dans l'OS et les packages système
# Outil : Trivy qui analyse les CVE dans les couches Docker (image de base, packages installés)
# Recherche les vulnérabilités CRITICAL uniquement (pragmatisme DevSecOps)
# ═══════════════════════════════════════
container-scan:
  name: Container Scan
  runs-on: ubuntu-latest
  needs: build
  steps:
    - uses: actions/download-artifact@v4
      with:
        name: docker-image

    - name: Load image
      run: docker load < image.tar

    - name: Trivy scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: vuln-app:${{ github.sha }}
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL'

# ═══════════════════════════════════════
# 6. RAPPORT FINAL
# Génère un résumé de tous les scans de sécurité
# Vérifie le statut de chaque job et fait ÉCHOUER le pipeline si des vulnérabilités sont détectées
# S'exécute toujours (if: always()) même si des jobs précédents ont échoué
# ═══════════════════════════════════════
report:
  name: Report
  runs-on: ubuntu-latest
  needs: [sast, sca, secrets, container-scan]
  if: always()

steps:
  - name: Generate JSON Report
    run: |
      cat > security-report.json <<EOF
      {
        "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
        "repository": "${{ github.repository }}",
        "commit": "${{ github.sha }}",
        "branch": "${{ github.ref_name }}",
        "workflow_run": "${{ github.run_id }}",
        "results": {
          "sast": {
            "status": "${{ needs.sast.result }}",
            "tool": "Semgrep"
          },
          "sca": {
            "status": "${{ needs.sca.result }}",
            "tool": "npm audit"
          },
          "secrets": {
            "status": "${{ needs.secrets.result }}",
            "tool": "Gitleaks"
          },
          "container_scan": {
            "status": "${{ needs.container-scan.result }}",
            "tool": "Trivy"
          }
        },
        "summary": {
        "total_checks": 4,
        "passed": $(echo '${{ needs.sast.result }} ${{ needs.sca.result }} ${{ needs.secrets.result }} ${{ needs.containe
        "failed": $(echo '${{ needs.sast.result }} ${{ needs.sca.result }} ${{ needs.secrets.result }} ${{ needs.containe
        "overall_status": "$([[ "${{ needs.sast.result }}" == "failure" ]] || [[ "${{ needs.sca.result }}" == "failure" ]
        }
      }
      EOF

      echo " Security Report Generated:"
      cat security-report.json | jq '.'

  - name: Upload JSON Report
    uses: actions/upload-artifact@v4
    with:
      name: security-report
      path: security-report.json

  - name: Summary
run: |
  echo "## Security Scan Complete" >> $GITHUB_STEP_SUMMARY
  echo "" >> $GITHUB_STEP_SUMMARY
  echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
  echo "- SAST: ${{ needs.sast.result }}" >> $GITHUB_STEP_SUMMARY
  echo "- SCA: ${{ needs.sca.result }}" >> $GITHUB_STEP_SUMMARY
  echo "- Secrets: ${{ needs.secrets.result }}" >> $GITHUB_STEP_SUMMARY
  echo "- Container Scan: ${{ needs.container-scan.result }}" >> $GITHUB_STEP_SUMMARY
  echo "" >> $GITHUB_STEP_SUMMARY
  echo " **JSON Report available in artifacts**" >> $GITHUB_STEP_SUMMARY
  echo "" >> $GITHUB_STEP_SUMMARY

  if [[ "${{ needs.sast.result }}" == "failure" ]] || \
     [[ "${{ needs.sca.result }}" == "failure" ]] || \
     [[ "${{ needs.secrets.result }}" == "failure" ]] || \
     [[ "${{ needs.container-scan.result }}" == "failure" ]]; then
    echo " **Security issues detected!**" >> $GITHUB_STEP_SUMMARY
    echo "" >> $GITHUB_STEP_SUMMARY
    echo " Please review the failed jobs above" >> $GITHUB_STEP_SUMMARY
    exit 1

  else
    echo " All security checks passed" >> $GITHUB_STEP_SUMMARY
  fi
